<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§‘å¹»æ“¬ç‰©å¤©æ°£å„€è¡¨æ¿</title>
    <!-- ä¿æŒ Inter å­—é«”ï¼Œå®ƒåœ¨å°ˆæ¥­/ç§‘å¹»ä»‹é¢ä¸­è¡¨ç¾è‰¯å¥½ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* æ·±è‰²ç§‘å¹»æ“¬ç‰©é…è‰²æ–¹æ¡ˆ */
        :root {
            --base-dark: #2C3E50;
            /* æ·±è—ç°èƒŒæ™¯ */
            --base-light: #34495E;
            /* å¡ç‰‡åŸºåº•è‰² (æ¯”èƒŒæ™¯ç¨äº®) */
            --primary-accent: #00FFFF;
            /* é›»å…‰é’è‰² (ç§‘å¹»å¼·èª¿è‰²) */
            --text-light: #ECF0F1;
            /* æ·ºç°æ–‡å­— */
            --shadow-dark: #202E3D;
            /* æ“¬ç‰©åŒ–æ·±è‰²é™°å½± */
            --shadow-light: #446481;
            /* æ“¬ç‰©åŒ–æ·ºè‰²é™°å½± */
            --error-red: #E74C3C; /* éŒ¯èª¤æç¤ºè‰² */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--base-dark);
            min-height: 100vh;
            color: var(--text-light);
            overflow-x: hidden;
            padding-bottom: 30px;
        }

        /* Loading Screen èª¿æ•´ç‚ºç§‘å¹»é¢¨æ ¼ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--base-dark);
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        /* Loading åœ–ç¤ºä½¿ç”¨å¼·èª¿è‰²ï¼Œä¸¦åŠ å…¥è„ˆè¡å‹•ç•« */
        .loading-icon {
            color: var(--primary-accent) !important;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
            animation: pulse 1.5s infinite alternate;
        }
        
        /* éŒ¯èª¤ç‹€æ…‹çš„åœ–ç¤ºå’Œæ–‡å­— */
        .error-icon {
            color: var(--error-red);
            text-shadow: 0 0 15px rgba(231, 76, 60, 0.6);
        }

        @keyframes pulse {
            from {
                transform: scale(1);
                opacity: 0.8;
            }
            to {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        /* é ‚éƒ¨ç‹€æ…‹åˆ—ï¼šèå…¥èƒŒæ™¯ï¼Œä½¿ç”¨å…§å‡¹æ•ˆæœ */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--base-dark);
            box-shadow: inset 0 -2px 4px var(--shadow-dark);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        /* åœ°é»é¸æ“‡å™¨é¢¨æ ¼åŒ– */
        .location-select {
            background-color: var(--base-dark);
            color: var(--primary-accent);
            border: 1px solid var(--primary-accent);
            border-radius: 9999px; /* åœ“è§’è† å›Š */
            padding: 8px 15px;
            font-weight: 600;
            font-size: 1rem;
            
            /* æ“¬ç‰©åŒ–å…§å‡¹æ•ˆæœ */
            box-shadow: inset 2px 2px 5px var(--shadow-dark),
                        inset -2px -2px 5px var(--shadow-light);
            appearance: none; /* éš±è—åŸç”Ÿç®­é ­ */
            /* è‡ªå®šç¾©ç®­é ­ SVG */
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'><path fill='%2300FFFF' d='M5 8l5 5 5-5z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 35px; /* ç‚ºç®­é ­ç•™å‡ºç©ºé–“ */
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .location-select:focus {
            outline: none;
            border-color: #00FFFF;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.6); /* èšç„¦æ™‚ç™¼å…‰ */
        }

        .update-pill {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 400;
        }

        .container {
            padding: 20px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* === æ ¸å¿ƒï¼šä»Šæ—¥ç„¦é»å¡ç‰‡ - æµ®å‡ºæ“¬ç‰©åŒ– === */
        .hero-card {
            background: var(--base-light);
            border-radius: 18px;
            padding: 35px 30px;
            text-align: left;
            box-shadow: 10px 10px 20px var(--shadow-dark),
                -10px -10px 20px var(--shadow-light);
            margin-bottom: 30px;
            transition: all 0.2s ease;
        }

        .hero-period {
            font-size: 1rem;
            color: var(--primary-accent);
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .hero-temp-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0 25px 0;
        }

        .hero-icon {
            font-size: 6rem;
            line-height: 1;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.2));
        }

        .hero-temp {
            font-size: 5.5rem;
            font-weight: 800;
            color: var(--primary-accent);
            line-height: 1;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .hero-desc {
            font-size: 1.2rem;
            color: var(--text-light);
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* === å¿«é€Ÿå»ºè­°å€ - å…§å‡¹å€å¡Šè¨­è¨ˆ === */
        .advice-grid {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid var(--shadow-dark);
        }

        .advice-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            background: var(--base-dark);
            box-shadow: inset 5px 5px 10px var(--shadow-dark),
                inset -5px -5px 10px var(--base-light);
        }

        .advice-icon {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .advice-text {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light);
            line-height: 1.3;
        }

        /* === é å ±å€å¡Š - æ•¸æ“šæ¨¡å¡ŠåŒ– === */
        .section-title {
            font-size: 1.3rem;
            color: var(--text-light);
            margin-top: 35px;
            margin-bottom: 5px; 
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        .section-subtitle {
            font-size: 0.9rem;
            color: var(--text-light);
            opacity: 0.7;
            margin-bottom: 15px;
        }


        .scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 15px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .scroll-container::-webkit-scrollbar {
            display: none;
        }

        .mini-card {
            min-width: 130px;
            background: var(--base-light);
            border-radius: 12px;
            padding: 18px 12px;
            text-align: center;
            box-shadow: 6px 6px 12px var(--shadow-dark),
                -6px -6px 12px var(--shadow-light);
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .mini-card:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark),
                        inset -4px -4px 8px var(--shadow-light);
            transform: scale(0.98);
        }

        .mini-time {
            background: var(--base-dark);
            color: var(--primary-accent);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            display: inline-block;
            margin-bottom: 10px;
            font-weight: 600;
            box-shadow: inset 3px 3px 6px var(--shadow-dark),
                        inset -3px -3px 6px var(--shadow-light);
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.4);
        }

        .mini-icon {
            font-size: 2.5rem;
            margin: 8px 0;
        }

        .mini-temp {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text-light);
        }
    </style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loading" class="loading-screen">
        <div style="font-size: 4rem;" class="loading-icon" id="loadingIcon">ğŸ“¡</div>
        <p style="color: var(--primary-accent); font-weight: 600; margin-top: 20px;" id="loadingText">æ­£åœ¨å•Ÿå‹•ç³»çµ±ï¼Œè®€å–æ°£è±¡æ•¸æ“š...</p>
    </div>

    <!-- Header/Status Bar -->
    <div class="status-bar">
        <!-- åŸå¸‚é¸æ“‡å™¨ -->
        <select id="citySelector" class="location-select"></select>
        <div id="updateTime" class="update-pill">ç³»çµ±æ™‚é–“ï¼šåŒæ­¥ä¸­...</div>
    </div>

    <!-- Main Content -->
    <div class="container" id="mainContent" style="display: none;">

        <div id="heroCard">
        </div>

        <!-- æ¨™é¡Œå’Œå‰¯æ¨™é¡Œå°‡ç”± JavaScript å‹•æ…‹è¨­å®š -->
        <h3 class="section-title" id="forecastTitle"></h3>
        <p class="section-subtitle" id="forecastSubtitle"></p>
        
        <div class="scroll-container" id="futureForecasts">
            <!-- é å ±å¡ç‰‡å°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
        </div>

    </div>

    <script>
        // API åŸºç¤è·¯å¾‘
        const API_BASE_URL = "https://taipei-weatherapi.zeabur.app/api/weather/";
        
        // å¯ç”¨çš„åŸå¸‚ç«¯é» (slug: é¡¯ç¤ºåç¨±)
        const CITY_ENDPOINTS = {
            'geolocation': 'åµæ¸¬ç›®å‰ä½ç½® (GPS)',
            'taipei': 'å°åŒ—å¸‚',
            'taichung': 'å°ä¸­å¸‚',
            'kaohsiung': 'é«˜é›„å¸‚'
        };

        // è¿½è¹¤ç•¶å‰é¸æ“‡çš„åŸå¸‚ slug (ç”¨æ–¼éŒ¯èª¤æ™‚åˆ‡å›)
        let currentCitySlug = 'kaohsiung'; // é è¨­ç‚ºé«˜é›„

        // --- Utility Functions (ä¿æŒä¸è®Š) ---
        
        function getWeatherIcon(weather) {
            if (!weather) return "ğŸ“¡"; 
            if (weather.includes("æ™´")) return "â˜€ï¸";
            if (weather.includes("å¤šé›²")) return "ğŸŒ¥ï¸";
            if (weather.includes("é™°")) return "â˜ï¸";
            if (weather.includes("é›¨")) return "â˜”"; 
            if (weather.includes("é›·")) return "âš¡";
            return "ğŸŒ¤ï¸";
        }

        function getAdvice(rainProb, maxTemp) {
            let rainIcon = "âœ…";
            let rainText = "é™æ°´æ©Ÿç‡ï¼š0-30% (ç„¡é ˆæº–å‚™)";
            if (parseInt(rainProb) > 30) {
                rainIcon = "âš ï¸";
                rainText = "é™æ°´æ©Ÿç‡ï¼š30-60% (å»ºè­°æ”œå¸¶å‚˜å…·)";
            }
            if (parseInt(rainProb) > 60) {
                rainIcon = "ğŸš¨";
                rainText = "é™æ°´æ©Ÿç‡ï¼š>60% (å¿…é ˆè£å‚™é˜²è­·å‚˜å…·)";
            }

            let clothIcon = "ğŸ‘•";
            let clothText = "æœè£æŒ‡æ•¸ï¼šç©©å®š";
            if (parseInt(maxTemp) >= 28) {
                clothIcon = "ğŸ”¥";
                clothText = "æœè£æŒ‡æ•¸ï¼šé«˜ç†± (å»ºè­°è¼•è–„)";
            } else if (parseInt(maxTemp) <= 20) {
                clothIcon = "ğŸ§¥";
                clothText = "æœè£æŒ‡æ•¸ï¼šä½æº« (å»ºè­°ä¿æš–å±¤)";
            }

            return { rainIcon, rainText, clothIcon, clothText };
        }

        function getDayKey(dateString) {
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }
        
        const daysOfWeek = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
        
        function getDayInfo(dateString) {
            const date = new Date(dateString);
            const dayName = daysOfWeek[date.getDay()];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return { dayKey: getDayKey(dateString), dayName: dayName, dateText: `${month}/${day}` };
        }
        
        // --- æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ (ä¿æŒä¸è®Š) ---

        function renderWeather(data, cityName) {
            const forecasts = data.forecasts;
            if (!forecasts || forecasts.length === 0) {
                // å¦‚æœæˆåŠŸä½†æ•¸æ“šç‚ºç©ºï¼Œä¹Ÿè¦–ç‚ºéŒ¯èª¤
                 throw new Error("No forecast data available.");
            }

            const current = forecasts[0];
            const advice = getAdvice(current.rain, current.maxTemp);
            const avgTemp = Math.round((parseInt(current.maxTemp) + parseInt(current.minTemp)) / 2);

            document.getElementById('heroCard').innerHTML = `
                        <div class="hero-card">
                            <div class="hero-period">æ•¸æ“šç›£æ§ä¸­ï¼šç•¶å‰ç‹€æ…‹ (${cityName})</div>
                            <div class="hero-temp-container">
                                <div class="hero-temp">${avgTemp}Â°</div>
                                <div class="hero-icon">${getWeatherIcon(current.weather)}</div>
                            </div>
                            <div class="hero-desc">ç›®æ¨™åœ°å€ï¼š${current.weather} / æº«å·® ${current.minTemp}Â° - ${current.maxTemp}Â°</div>
                            
                            <div class="advice-grid">
                                <div class="advice-item">
                                    <div class="advice-icon">${advice.rainIcon}</div>
                                    <div class="advice-text">${advice.rainText}</div>
                                    <div style="font-size:0.75rem; color:var(--text-light); opacity: 0.7; margin-top:3px;">é™é›¨ç‡ ${current.rain}%</div>
                                </div>
                                <div class="advice-item">
                                    <div class="advice-icon">${advice.clothIcon}</div>
                                    <div class="advice-text">${advice.clothText}</div>
                                    <div style="font-size:0.75rem; color:var(--text-light); opacity: 0.7; margin-top:3px;">æ¿•åº¦ ${current.humidity}%</div>
                                </div>
                            </div>
                        </div>
                    `;

            const scrollContainer = document.getElementById('futureForecasts');
            scrollContainer.innerHTML = '';

            const dailySummaries = {};

            data.forecasts.forEach((f, index) => {
                const { dayKey, dayName, dateText } = getDayInfo(f.startTime);

                if (!dailySummaries[dayKey]) {
                    dailySummaries[dayKey] = {
                        dayName: index === 0 ? "ä»Šæ—¥" : dayName,
                        dateText: dateText,
                        minTemp: parseInt(f.minTemp),
                        maxTemp: parseInt(f.maxTemp),
                        weather: f.weather,
                        rain: parseInt(f.rain)
                    };
                } else {
                    dailySummaries[dayKey].minTemp = Math.min(dailySummaries[dayKey].minTemp, parseInt(f.minTemp));
                    dailySummaries[dayKey].maxTemp = Math.max(dailySummaries[dayKey].maxTemp, parseInt(f.maxTemp));
                    dailySummaries[dayKey].weather = dailySummaries[dayKey].weather.includes(f.weather) ? dailySummaries[dayKey].weather : `${dailySummaries[dayKey].weather}è½‰${f.weather}`;
                    dailySummaries[dayKey].rain = Math.max(dailySummaries[dayKey].rain, parseInt(f.rain));
                }
            });
            
            const dailyArray = Object.values(dailySummaries);
            const daysCount = dailyArray.length;

            if (daysCount >= 5) {
                document.getElementById('forecastTitle').textContent = `æœªä¾† ${daysCount} å¤©å¤©æ°£æ¦‚æ³`;
                document.getElementById('forecastSubtitle').textContent = `ç³»çµ±é è¨ˆè¦†è“‹ç¯„åœï¼š${dailyArray[0].dateText} è‡³ ${dailyArray[daysCount - 1].dateText}`;
            } else {
                document.getElementById('forecastTitle').textContent = `æœªä¾† 48 å°æ™‚æ•¸æ“šæ¦‚æ³`;
                document.getElementById('forecastSubtitle').textContent = `âš ï¸ è­¦å‘Šï¼šç›®å‰åƒ…æ“·å–åˆ° ${daysCount} å¤©å®Œæ•´æ•¸æ“šï¼Œç„¡æ³•æä¾›ä¸€é€±é å ±ã€‚`;
            }

            dailyArray.forEach((f) => {
                const displayWeather = f.weather.split('è½‰')[0];

                scrollContainer.innerHTML += `
                    <div class="mini-card">
                        <div class="mini-time">${f.dayName} (${f.dateText})</div>
                        <div class="mini-icon">${getWeatherIcon(displayWeather)}</div>
                        <div class="mini-temp">${f.minTemp}Â° ~ ${f.maxTemp}Â°</div>
                        <div style="font-size:0.8rem; color:var(--primary-accent); margin-top:8px; font-weight: 600;">ğŸ’§ ${f.rain}%</div>
                    </div>
                `;
            });

            const now = new Date();
            const formatter = new Intl.DateTimeFormat('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short', hour: '2-digit', minute: '2-digit', hour12: false });
            document.getElementById('updateTime').textContent = `ç³»çµ±æ™‚é–“ï¼š${formatter.format(now)}`;
        }

        // --- Geolocation é‚è¼¯ (ä¿æŒä¸è®Š) ---

        /**
         * è™•ç† Geolocation æˆåŠŸçš„å›èª¿
         */
        function geolocationSuccess(pos) {
            const latitude = pos.coords.latitude;
            const longitude = pos.coords.longitude;
            let citySlug = 'kaohsiung'; // é è¨­é«˜é›„

            // ç°¡æ˜“çš„å°ç£åŸå¸‚ç¯„åœåˆ¤æ–· (åƒ…ç”¨æ–¼é¸æ“‡ API åŸå¸‚)
            if (latitude > 24.5) {
                if (latitude > 24.8 && longitude < 121.6) {
                    citySlug = 'taipei'; // è·é›¢å°åŒ—è¼ƒè¿‘
                } else {
                    citySlug = 'taichung'; // è·é›¢å°ä¸­è¼ƒè¿‘
                }
            }
            
            const selector = document.getElementById('citySelector');
            selector.value = citySlug;
            // æ›´æ–° currentCitySlugï¼Œæº–å‚™å¦‚æœç™¼ç”ŸéŒ¯èª¤æ™‚åˆ‡æ›å›é€™å€‹åŸå¸‚
            // NOTE: æ­¤è™•ä¸æ›´æ–° currentCitySlugï¼Œç­‰åˆ° fetchWeather æˆåŠŸå¾Œå†æ›´æ–°
            
            // èª¿æ•´é¡¯ç¤ºåç¨±ï¼ŒåŠ å…¥ "ç›®å‰ä½ç½®"
            const cityName = CITY_ENDPOINTS[citySlug] + ' (GPSå®šä½)';
            selector.options[selector.selectedIndex].text = cityName;

            fetchWeather(citySlug, cityName);
        }

        /**
         * è™•ç† Geolocation å¤±æ•—çš„å›èª¿
         */
        function geolocationError(err) {
            console.warn(`Geolocation ERROR(${err.code}): ${err.message}`);
            
            const selector = document.getElementById('citySelector');
            // å°‡é¸æ“‡å™¨è¨­å®šå›é è¨­æˆ–ä¸Šä¸€å€‹æˆåŠŸçš„åŸå¸‚ (åœ¨é€™è£¡æ˜¯ currentCitySlug)
            selector.value = currentCitySlug; 
            
            const defaultCityName = CITY_ENDPOINTS[currentCitySlug];

            // æç¤ºå®šä½å¤±æ•—ï¼Œä¸¦è¼‰å…¥é è¨­åŸå¸‚
            const loadingText = document.getElementById('loadingText');
            document.getElementById('loadingIcon').className = 'error-icon';
            document.getElementById('loadingIcon').textContent = 'âš ï¸';
            loadingText.style.color = 'var(--error-red)';
            loadingText.textContent = `å®šä½å¤±æ•— (${err.message})ï¼Œæ­£åœ¨è¼‰å…¥é è¨­åŸå¸‚ ${defaultCityName} æ•¸æ“š...`;
            
            fetchWeather(currentCitySlug, defaultCityName);
        }

        /**
         * å˜—è©¦ç²å–ä½¿ç”¨è€…ä½ç½®
         */
        function getUserLocation() {
            // é¡¯ç¤º Loading
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loading').style.opacity = '1';
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loadingIcon').className = 'loading-icon';
            document.getElementById('loadingIcon').textContent = 'ğŸ“¡';
            document.getElementById('loadingText').style.color = 'var(--primary-accent)';
            document.getElementById('loadingText').textContent = "æ­£åœ¨é€é GPS åº§æ¨™åµæ¸¬ç›®å‰ä½ç½®...";

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(geolocationSuccess, geolocationError, { timeout: 10000 });
            } else {
                geolocationError({code: 0, message: "ç€è¦½å™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½ã€‚"});
            }
        }

        // --- æ ¸å¿ƒæ•¸æ“šæŠ“å–å‡½å¼ (å¢åŠ éŒ¯èª¤è™•ç†) ---

        async function fetchWeather(citySlug, cityName) {
            const apiUrl = API_BASE_URL + citySlug;
            
            // ç•¶é–‹å§‹æŠ“å–æ–°æ•¸æ“šæ™‚ï¼Œé‡è¨­ loading ç‹€æ…‹ç‚ºæ­£å¸¸
            const loadingEl = document.getElementById('loading');
            loadingEl.innerHTML = `
                <div style="font-size: 4rem;" class="loading-icon" id="loadingIcon">ğŸ“¡</div>
                <p style="color: var(--primary-accent); font-weight: 600; margin-top: 20px;" id="loadingText">æ­£åœ¨è¼‰å…¥ ${cityName} çš„æ°£è±¡æ•¸æ“š...</p>
            `;
            
            try {
                // 1. å®šç¾©ã€Œæœ€ä½ç­‰å¾…æ™‚é–“ã€ï¼š1500 æ¯«ç§’ (1.5ç§’)
                const delayPromise = new Promise(resolve => setTimeout(resolve, 1500));
                const fetchPromise = fetch(apiUrl).then(res => res.json());
                const [_, json] = await Promise.all([delayPromise, fetchPromise]);

                if (json.success) {
                    renderWeather(json.data, cityName);
                    
                    // *** é—œéµæ›´æ–°ï¼šæˆåŠŸæ™‚æ‰æ›´æ–° currentCitySlug ***
                    currentCitySlug = citySlug;

                    // æˆåŠŸï¼šéš±è— Loadingï¼Œé¡¯ç¤ºä¸»ç•«é¢
                    document.getElementById('loading').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'block';
                    }, 500); 

                } else {
                    // API è¿”å› {success: false} æˆ–æ•¸æ“šçµæ§‹ç•°å¸¸
                    // æ­¤éŒ¯èª¤æœƒè¢« catch å€å¡Šæ•ç²ï¼Œä¸¦é¡¯ç¤ºå‹å¥½çš„ UI éŒ¯èª¤æç¤º
                    throw new Error("API reported failure or missing data.");
                }
            } catch (e) {
                console.error("Fetch Error:", e);
                
                // å¤±æ•—ï¼šé¡¯ç¤ºéŒ¯èª¤æç¤ºï¼Œä¸¦ç¢ºä¿ä¸»å…§å®¹éš±è—
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('loading').style.opacity = '1';
                document.getElementById('loading').style.display = 'flex';
                
                // ç”±æ–¼å¤±æ•—ï¼ŒcurrentCitySlug ä¿ç•™ä¸Šä¸€å€‹æˆåŠŸçš„åŸå¸‚

                loadingEl.innerHTML = `
                    <div style="font-size: 4rem;" class="error-icon">âŒ</div>
                    <p style="color: var(--error-red); font-weight: 600; margin-top: 20px;">
                        æ•¸æ“šå‚³è¼¸å¤±æ•—ï¼šåŸå¸‚ ${cityName} çš„æ ¸å¿ƒè³‡æ–™åº«ç„¡éŸ¿æ‡‰ã€‚
                    </p>
                    <p style="color: var(--text-light); opacity: 0.7; font-size: 0.9rem; margin-top: 10px;">
                        è«‹å˜—è©¦åˆ‡æ›åˆ°å…¶ä»–åŸå¸‚ (å¦‚é«˜é›„å¸‚)ï¼Œæˆ–ç¨å¾Œé‡è©¦ã€‚
                    </p>
                `;
            }
        }
        
        // --- äº‹ä»¶è™•ç†èˆ‡åˆå§‹åŒ– (ä¿æŒä¸è®Š) ---
        
        function handleCitySelection(event) {
            const slug = event.target.value;
            const cityName = CITY_ENDPOINTS[slug];

            if (slug === 'geolocation') {
                getUserLocation();
            } else {
                // NOTE: ä¸åœ¨æ­¤è™•æ›´æ–° currentCitySlugï¼Œæ”¹åœ¨ fetchWeather æˆåŠŸå¾Œæ›´æ–°ã€‚
                // Start fetching data
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('loading').style.opacity = '1';
                document.getElementById('loading').style.display = 'flex';
                fetchWeather(slug, cityName);
            }
        }

        function initApp() {
            const selector = document.getElementById('citySelector');
            
            for (const [slug, name] of Object.entries(CITY_ENDPOINTS)) {
                const option = document.createElement('option');
                option.value = slug;
                option.textContent = name;
                selector.appendChild(option);
            }

            selector.value = currentCitySlug;
            selector.addEventListener('change', handleCitySelection);
            
            // é¦–æ¬¡è¼‰å…¥æ™‚ï¼Œå¾é è¨­åŸå¸‚é–‹å§‹æŠ“å–æ•¸æ“š (Kaohsiung)
            fetchWeather(currentCitySlug, CITY_ENDPOINTS[currentCitySlug]);
        }


        document.addEventListener("DOMContentLoaded", initApp);
    </script>
</body>

</html>